---
#- name: Stop systemd-resolved
#  systemd:
#    name: systemd-resolved
#    state: stopped
#    enabled: false

- name: Install dnsmasq
  apt:
    name:
      - dnsmasq
    state: present
  become: true

- name: Write dnsmasq conf
  blockinfile:
    path: /etc/dnsmasq.conf
    block: |
      no-hosts
      no-poll
      resolve-file=/etc/dnsmasq_resolv.conf
      listen-address=127.0.0.1
      listen-address=::1
      listen-address=172.16.20.1
      conf-file=/etc/dnsmasq.rabbit-house.conf
      interface=eth0
      no-dhcp-interface=

- name: Write resolved conf
  blockinfile:
    path: /etc/systemd/resolved.conf
    block: |
      DNS=127.0.0.1

- name: Copy dnsmasq_resolv.conf
  copy:
    src: dnsmasq/dnsmasq_resolv.conf
    dest: /etc/dnsmasq_resolv.conf
    mode: 0644
  become: true

- name: Copy dnsmasq.rabbit-house.conf
  copy:
    src: dnsmasq/dnsmasq.rabbit-house.conf
    dest: /etc/dnsmasq.rabbit-house.conf
    mode: 0644
  become: true

- name: Copy dnsmasq_adblock.sh
  copy:
    src: dnsmasq/dnsmasq_adblock.sh
    dest: /opt/
  become: true

- name: Copy additional_hosts.txt
  copy:
    src: dnsmasq/additional_hosts.txt
    dest: /opt/
  become: true

- name: Copy dnsmasq_adblock.service
  copy:
    src: dnsmasq/dnsmasq_adblock.service
    dest: /etc/systemd/system/
  become: true

- name: Copy dnsmasq_adblock.timer
  copy:
    src: dnsmasq/dnsmasq_adblock.timer
    dest: /etc/systemd/system/
  become: true

- name: Stop systemd-resolved
  systemd:
    name: systemd-resolved
    state: stopped

- name: Restart dnsmasq
  systemd:
    name: dnsmasq
    state: restarted
    enabled: true

- name: Restart systemd-resolved
  systemd:
    name: systemd-resolved
    state: restarted
    enabled: true

- name: Enable and restart adblock
  systemd:
    name: dnsmasq_adblock
    state: restarted
    enabled: true
  become: true

- name: Allow port 53
  ufw:
    rule: allow
    proto: any
    to_port: 53
